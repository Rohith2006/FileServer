name: CD Pipeline

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mini-file-server
  DEPLOYMENT_NAME: mini-file-server
  NAMESPACE: default

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Kind cluster for deployment
      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster

      - name: Verify Kubernetes cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      # Pull image to Kind cluster
      - name: Pull Docker Image
        run: |
          docker pull ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}
          kind load docker-image ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }} --name test-cluster

      # Deploy application to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          # Update image tag in deployment
          sed -i "s|IMAGE_TAG|${{ github.event.inputs.image_tag }}|g" k8s/deployment.yaml
          sed -i "s|DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/deployment.yaml
          
          # Apply manifests
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=300s

      - name: Verify Deployment
        run: |
          echo "üì¶ Pods:"
          kubectl get pods -l app=${{ env.DEPLOYMENT_NAME }}
          echo ""
          echo "üåê Services:"
          kubectl get services

      # Port forward for testing
      - name: Setup Port Forward and Health Check
        run: |
          kubectl port-forward service/${{ env.DEPLOYMENT_NAME }} 8080:8080 &
          sleep 10
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")
          echo "Health check response: $response"
          
          if [ "$response" != "200" ]; then
            echo "‚ùå Health check failed!"
            kubectl logs -l app=${{ env.DEPLOYMENT_NAME }} --tail=50
            exit 1
          fi
          echo "‚úÖ Health check passed!"

      # Display deployment information
      - name: Deployment Summary
        run: |
          echo "============================================"
          echo "‚úÖ CD Pipeline completed successfully!"
          echo "============================================"
          echo "üì¶ Image: ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "üè∑Ô∏è Namespace: ${{ env.NAMESPACE }}"
          echo "üöÄ Deployment: ${{ env.DEPLOYMENT_NAME }}"
          echo "============================================"
          kubectl get all -l app=${{ env.DEPLOYMENT_NAME }}

      - name: Show Logs
        if: always()
        run: |
          echo "üìã Application Logs:"
          kubectl logs -l app=${{ env.DEPLOYMENT_NAME }} --tail=30 || true

      - name: Show Logs
        if: always()
        run: |
          echo "Application Logs:"
          kubectl logs -l app=${{ env.DEPLOYMENT_NAME }} --tail=50
