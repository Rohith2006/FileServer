name: CD Pipeline

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mini-file-server
  DEPLOYMENT_NAME: mini-file-server
  NAMESPACE: default

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Kind cluster for deployment
      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster

      - name: Verify Kubernetes cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      # Deploy application to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          # Update image tag in deployment
          sed -i "s|IMAGE_TAG|${{ github.event.inputs.image_tag }}|g" k8s/deployment.yaml
          sed -i "s|DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/deployment.yaml
          
          # Apply manifests
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=300s

      - name: Verify Deployment
        run: |
          kubectl get pods -l app=${{ env.DEPLOYMENT_NAME }}
          kubectl get services

      # Port forward for testing
      - name: Setup Port Forward
        run: |
          kubectl port-forward service/${{ env.DEPLOYMENT_NAME }} 8080:8080 &
          sleep 5

      - name: Health Check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health)
          if [ "$response" != "200" ]; then
            echo "Health check failed!"
            kubectl logs -l app=${{ env.DEPLOYMENT_NAME }}
            exit 1
          fi
          echo "Health check passed!"

      # DAST - OWASP ZAP Baseline Scan (non-blocking)
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: false
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: report_html.html

      # Display deployment information
      - name: Deployment Summary
        run: |
          echo "============================================"
          echo "Deployment completed successfully!"
          echo "============================================"
          echo "Image: ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo "Deployment: ${{ env.DEPLOYMENT_NAME }}"
          echo "============================================"
          kubectl get all -l app=${{ env.DEPLOYMENT_NAME }}

      - name: Show Logs
        if: always()
        run: |
          echo "Application Logs:"
          kubectl logs -l app=${{ env.DEPLOYMENT_NAME }} --tail=50
